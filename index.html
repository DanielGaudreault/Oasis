import React, { useEffect, useRef, useState } from "react";
import { motion } from "framer-motion";

// Single-file React component that implements a client-side "Oasis"-like demo.
// Notes:
// - No server required. Everything runs in the browser and uses localStorage for persistence.
// - Uses Tailwind utility classes (UI will render in the preview environment that supports Tailwind).
// - All images are procedural (canvas / SVG / CSS) so there are no copyrighted assets.
// - This is a playful, original homage â€” not a movie asset copy. Customize freely.

export default function OasisDemo() {
  const [username, setUsername] = useState(
    () => localStorage.getItem("oasis.username") || "GUEST"
  );
  const [avatar, setAvatar] = useState(() => localStorage.getItem("oasis.avatar") || "neon");
  const [room, setRoom] = useState(() => localStorage.getItem("oasis.room") || "lobby");
  const [chatMessages, setChatMessages] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem("oasis.chat")) || [];
    } catch (e) {
      return [];
    }
  });
  const [input, setInput] = useState("");
  const canvasRef = useRef(null);

  useEffect(() => {
    localStorage.setItem("oasis.username", username);
  }, [username]);
  useEffect(() => {
    localStorage.setItem("oasis.avatar", avatar);
  }, [avatar]);
  useEffect(() => {
    localStorage.setItem("oasis.room", room);
  }, [room]);
  useEffect(() => {
    localStorage.setItem("oasis.chat", JSON.stringify(chatMessages));
  }, [chatMessages]);

  // Starfield canvas
  useEffect(() => {
    const c = canvasRef.current;
    if (!c) return;
    const ctx = c.getContext("2d");
    let w = (c.width = c.clientWidth);
    let h = (c.height = c.clientHeight);
    const stars = Array.from({ length: 120 }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      z: Math.random() * 1,
    }));
    let raf;
    function resize() {
      w = c.width = c.clientWidth;
      h = c.height = c.clientHeight;
    }
    function draw() {
      ctx.fillStyle = "rgba(5,8,20,0.35)";
      ctx.fillRect(0, 0, w, h);
      for (const s of stars) {
        s.x += (s.z + 0.2);
        s.y += Math.sin(s.x * 0.001 + s.z * 10) * 0.3;
        s.z += 0.0005;
        if (s.x > w + 10 || s.y > h + 10) {
          s.x = -10; s.y = Math.random() * h; s.z = Math.random() * 1;
        }
        const r = (s.z + 0.1) * 1.8;
        ctx.beginPath();
        ctx.fillStyle = `rgba(200,220,255,${0.2 + s.z})`;
        ctx.arc(s.x, s.y, r, 0, Math.PI * 2);
        ctx.fill();
      }
      raf = requestAnimationFrame(draw);
    }
    window.addEventListener("resize", resize);
    draw();
    return () => { window.removeEventListener("resize", resize); cancelAnimationFrame(raf); };
  }, []);

  function postMessage() {
    if (!input.trim()) return;
    const msg = { id: Date.now(), user: username, avatar, text: input.trim(), time: new Date().toISOString() };
    setChatMessages(prev => [...prev, msg].slice(-200));
    setInput("");
  }

  const avatars = [
    { id: "neon", label: "Neon Runner" },
    { id: "mech", label: "Mech" },
    { id: "pix", label: "Pixel" },
    { id: "ghost", label: "Ghost" },
  ];
  const rooms = [
    { id: "lobby", name: "Lobby" },
    { id: "arcade", name: "Arcade" },
    { id: "sky", name: "Sky City" },
    { id: "forest", name: "Dream Forest" },
  ];

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-[#020617] to-[#071033] text-white">
      <canvas ref={canvasRef} className="fixed inset-0 -z-10" />

      <header className="flex items-center justify-between p-4 border-b border-white/5">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-black font-bold">O</div>
          <div>
            <div className="text-sm opacity-80">The Oasis â€” browser demo</div>
            <div className="text-xs opacity-60">pure client-side â€¢ no server â€¢ localStorage</div>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <div className="flex items-center gap-2 bg-white/5 p-2 rounded-md">
            <input className="bg-transparent outline-none w-36" value={username} onChange={e => setUsername(e.target.value)} />
            <button className="px-2 py-1 text-xs bg-white/10 rounded" onClick={() => { setUsername('Guest' + Math.floor(Math.random()*999)); }}>random</button>
          </div>
          <div className="flex items-center gap-2">
            {avatars.map(a => (
              <button key={a.id} className={`p-2 rounded ${avatar===a.id? 'ring-2 ring-white/40': 'hover:bg-white/5'}`} onClick={()=>setAvatar(a.id)} title={a.label}>
                <AvatarThumb id={a.id} size={28} />
              </button>
            ))}
          </div>
        </div>
      </header>

      <main className="flex-1 p-6 grid grid-cols-3 gap-6">
        <section className="col-span-2 bg-white/3 backdrop-blur-sm rounded-xl p-4 min-h-[60vh] flex flex-col">
          <div className="flex items-center justify-between mb-4">
            <div className="font-semibold text-lg">{rooms.find(r=>r.id===room).name}</div>
            <div className="flex gap-2">
              {rooms.map(r => (
                <button key={r.id} onClick={()=>setRoom(r.id)} className={`px-3 py-1 rounded ${room===r.id ? 'bg-white/10' : 'bg-white/5/10'}`}>
                  {r.name}
                </button>
              ))}
            </div>
          </div>

          <div className="flex-1 grid grid-cols-3 gap-4">
            <div className="col-span-2 rounded-lg p-3 bg-gradient-to-t from-white/2 to-transparent">
              <Scene room={room} avatar={avatar} username={username} />
            </div>

            <div className="rounded-lg p-3 bg-white/2 flex flex-col">
              <div className="font-medium mb-2">Mini-map</div>
              <MiniMap room={room} />
              <div className="mt-3 font-medium">Quick Actions</div>
              <div className="flex flex-col gap-2 mt-2">
                <button onClick={()=>alert('You warp to a new secret zone! (demo)')} className="py-2 rounded bg-white/10">Warp</button>
                <button onClick={()=>{ setChatMessages(prev => [...prev, { id:Date.now(), user:'SYSTEM', avatar:'ghost', text:`${username} explored a hidden easter egg.`, time:new Date().toISOString()}]); }} className="py-2 rounded bg-white/6">Find Easter Egg</button>
                <button onClick={()=>{ localStorage.clear(); window.location.reload(); }} className="py-2 rounded bg-red-600/60">Reset demo</button>
              </div>
            </div>
          </div>
        </section>

        <aside className="col-span-1 flex flex-col gap-4">
          <div className="rounded-xl p-3 bg-white/3 flex-1 flex flex-col">
            <div className="font-semibold">Chat</div>
            <div className="flex-1 mt-3 overflow-auto space-y-2">
              {chatMessages.slice(-50).map(m => (
                <div key={m.id} className="flex gap-2 items-start">
                  <AvatarThumb id={m.avatar} size={36} />
                  <div>
                    <div className="text-xs opacity-70">{m.user} â€¢ <span className="opacity-60 text-xxs">{new Date(m.time).toLocaleTimeString()}</span></div>
                    <div className="mt-1 text-sm">{m.text}</div>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-3 flex gap-2">
              <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter' && postMessage()} className="flex-1 rounded p-2 bg-transparent outline-none" placeholder="Say something..." />
              <button onClick={postMessage} className="px-3 rounded bg-white/10">Send</button>
            </div>
          </div>

          <div className="rounded-xl p-3 bg-white/4">
            <div className="font-semibold mb-2">Social Feed</div>
            <div className="space-y-2">
              <FeedItem text={`Welcome to ${rooms.find(r=>r.id===room).name}.`} small />
              <FeedItem text={`${username} joined the Oasis.`} />
              <FeedItem text={`Avatar set to ${avatars.find(a=>a.id===avatar).label}.`} />
            </div>
          </div>
        </aside>
      </main>

      <footer className="p-3 text-center text-xs opacity-70">This is a fan-made, original demo. No movie assets are included.</footer>
    </div>
  );
}

function AvatarThumb({ id, size=40 }){
  const style = { width: size, height: size };
  if(id==='neon'){
    return (
      <div style={style} className="rounded-md bg-gradient-to-br from-pink-500 to-indigo-500 flex items-center justify-center font-bold">N</div>
    );
  }
  if(id==='mech'){
    return (<div style={style} className="rounded-md bg-gray-800 flex items-center justify-center">ðŸ¤–</div>);
  }
  if(id==='pix'){
    return (<div style={style} className="rounded-md bg-yellow-400 flex items-center justify-center font-mono">PIX</div>);
  }
  return (<div style={style} className="rounded-md bg-white/10 flex items-center justify-center">?</div>);
}

function Scene({ room, avatar, username }){
  // Simple scene which changes layout/colours based on room
  const bg = {
    lobby: 'from-[#05203A] to-[#0B1020]',
    arcade: 'from-[#0b021f] to-[#2b004b]',
    sky: 'from-[#002b3a] to-[#005a9c]',
    forest: 'from-[#012a0f] to-[#003b2a]'
  }[room] || 'from-[#05203A] to-[#0B1020]';

  return (
    <div className={`h-full w-full rounded-lg p-4 bg-gradient-to-br ${bg} relative overflow-hidden`}>
      <motion.div initial={{ opacity:0 }} animate={{ opacity:1 }} className="absolute -left-20 -top-20 w-96 h-96 rounded-full blur-3xl opacity-40 bg-white/5"></motion.div>

      <div className="flex items-center gap-4">
        <div className="w-20 h-20 rounded-md bg-white/6 flex items-center justify-center text-2xl font-bold">{username[0]||'G'}</div>
        <div>
          <div className="text-sm opacity-80">{username}</div>
          <div className="text-xs opacity-60">{room === 'arcade' ? 'High-score: 12345' : 'Exploring...'}</div>
        </div>
      </div>

      <div className="mt-6 grid grid-cols-3 gap-4">
        <Tile title="Portal" subtitle="Enter a world" onClick={()=>alert('Portal opened (demo)')} />
        <Tile title="Vendor" subtitle="Buy a shader" onClick={()=>alert('Purchased: Neon shine')} />
        <Tile title="Arena" subtitle="Challenge" onClick={()=>alert('Entering arena...')} />
      </div>

      <div className="absolute right-4 bottom-4 flex items-center gap-3">
        <div className="p-3 rounded bg-white/6">Avatar: <AvatarThumb id={avatar} size={32} /></div>
        <div className="p-3 rounded bg-white/6">Room: {room}</div>
      </div>
    </div>
  );
}

function Tile({ title, subtitle, onClick }){
  return (
    <motion.button whileHover={{ scale:1.03 }} whileTap={{ scale:0.98 }} onClick={onClick} className="rounded-lg p-3 bg-white/4 flex flex-col justify-between">
      <div className="font-semibold">{title}</div>
      <div className="text-xs opacity-70">{subtitle}</div>
    </motion.button>
  );
}

function MiniMap({ room }){
  return (
    <div className="mt-2 p-2 rounded bg-white/6">
      <svg viewBox="0 0 120 80" className="w-full h-32">
        <rect x="0" y="0" width="120" height="80" rx="6" fill="rgba(255,255,255,0.03)" />
        <circle cx="20" cy="60" r="4" fill="white" opacity="0.7" />
        <circle cx="60" cy="30" r="5" fill="white" />
        <circle cx="95" cy="45" r="3" fill="white" opacity="0.6" />
        <text x="8" y="19" fontSize="6" fill="white">{room}</text>
      </svg>
    </div>
  );
}

function FeedItem({ text, small=false }){
  return (
    <div className={`p-2 rounded bg-white/6 ${small ? 'text-sm opacity-80' : ''}`}>{text}</div>
  );
}
